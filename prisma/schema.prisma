generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("POSTGRES_URL_NON_POOLING")
}

// ============================================
// ENUMS
// ============================================

enum UserRole {
  USER
  COACH
  ADMIN
}

enum SubscriptionTier {
  FREE
  PRO
  ELITE
}

enum AnalysisStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum Severity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum PlanStatus {
  ACTIVE
  PAUSED
  COMPLETED
  ABANDONED
}

enum MediaType {
  VIDEO
  IMAGE
}

enum TokenType {
  PASSWORD_RESET
  EMAIL_VERIFICATION
}

enum BadgeType {
  FIRST_ANALYSIS
  WEEK_PERFECT
  PLAN_COMPLETED
  IMPROVEMENT
  DEDICATION_30
  STREAK_7
  STREAK_30
  STREAK_100
  // Competition & Community badges
  FIRST_CHALLENGE
  FIRST_MATCH
  TEN_MATCHES
  FIFTY_MATCHES
  TIER_QUINTA
  TIER_CUARTA
  TIER_TERCERA
  TIER_SEGUNDA
  TIER_PRIMERA
  TOP_100_COUNTRY
  TOP_10_COUNTRY
  NUMBER_ONE_COUNTRY
  FIRST_FOLLOWER
  CLUB_FOUNDER
  COACH_CERTIFIED
  TOURNAMENT_WINNER
  TOURNAMENT_FINALIST
  FIRST_TOURNAMENT
}

// ============================================
// COMPETITION & COMMUNITY ENUMS
// ============================================

enum AccountType {
  PLAYER
  COACH
}

enum SkillTier {
  UNRANKED
  QUINTA_B
  QUINTA_A
  CUARTA_B
  CUARTA_A
  TERCERA_B
  TERCERA_A
  SEGUNDA_B
  SEGUNDA_A
  PRIMERA_B
  PRIMERA_A
}

enum ProfileVisibility {
  PUBLIC
  FRIENDS_ONLY
  PRIVATE
}

enum RankingPeriod {
  WEEKLY
  MONTHLY
  ALL_TIME
}

enum RankingCategory {
  GLOBAL
  COUNTRY
  SKILL_TIER
  AGE_GROUP
}

enum ChallengeStatus {
  PENDING
  ACCEPTED
  DECLINED
  CANCELLED
  COMPLETED
  EXPIRED
}

enum MatchResultType {
  WIN
  LOSS
  NO_SHOW
}

enum AvailabilityDay {
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
  SUNDAY
}

enum NotificationType {
  CHALLENGE_RECEIVED
  CHALLENGE_ACCEPTED
  CHALLENGE_DECLINED
  MATCH_RESULT_PENDING
  MATCH_CONFIRMED
  NEW_FOLLOWER
  COMMENT_ON_ANALYSIS
  RANKING_CHANGE
  BADGE_EARNED
  COACH_INVITATION
  TIER_PROMOTION
  // System
  SYSTEM_ANNOUNCEMENT
  // Provider lifecycle
  PROVIDER_APPLICATION_SUBMITTED
  PROVIDER_APPROVED
  PROVIDER_REJECTED
  // Booking lifecycle
  BOOKING_REQUESTED
  BOOKING_CONFIRMED
  BOOKING_REJECTED
  BOOKING_CANCELLED
  // Stringing lifecycle
  STRINGING_STATUS_UPDATE
  STRINGING_COMPLETED
  STRINGING_READY_FOR_PICKUP
  // Coach request lifecycle
  COACH_REQUEST_RECEIVED
  COACH_REQUEST_ACCEPTED
  COACH_REQUEST_DECLINED
}

enum FeedItemType {
  ANALYSIS_COMPLETED
  BADGE_EARNED
  TIER_PROMOTION
  MATCH_PLAYED
  STREAK_MILESTONE
  RANKING_MILESTONE
}

enum ReportReason {
  SPAM
  INAPPROPRIATE
  HARASSMENT
  FAKE_PROFILE
  OTHER
}

enum TournamentStatus {
  REGISTRATION
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum TournamentFormat {
  SINGLE_ELIMINATION
  DOUBLE_ELIMINATION
  ROUND_ROBIN
}

enum CoachVerificationStatus {
  PENDING_VERIFICATION
  VERIFIED
  REJECTED
}

enum CoachStudentStatus {
  PENDING_INVITE
  PENDING_REQUEST
  ACTIVE
  PAUSED
  ENDED
}

enum VerificationStatus {
  UNVERIFIED
  PENDING_REVIEW
  VERIFIED
  FLAGGED
  REJECTED_VERIFICATION
}

enum DocumentStatus {
  UPLOADING
  PROCESSING
  COMPLETED
  FAILED
}

// ============================================
// SHOP & STRINGING ENUMS
// ============================================

enum ProductCategory {
  RACKETS
  STRINGS
  GRIPS
  BAGS
  SHOES
  APPAREL
  ACCESSORIES
}

enum OrderStatus {
  PENDING_PAYMENT
  PAID
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED
}

enum StringingOrderStatus {
  PENDING_PAYMENT
  CONFIRMED
  PICKUP_SCHEDULED
  RECEIVED_AT_WORKSHOP
  IN_PROGRESS
  STRINGING_COMPLETED
  READY_FOR_PICKUP
  OUT_FOR_DELIVERY
  DELIVERED
  STRINGING_CANCELLED
}

enum DeliveryMode {
  HOME_PICKUP_DELIVERY
  WORKSHOP_DROP_PICKUP
}

enum StringingServiceType {
  STANDARD
  EXPRESS
}

enum ChunkCategory {
  THEORY
  EXERCISE
  TRAINING_PLAN
  GENERAL
}

// ============================================
// PROVIDER MARKETPLACE
// ============================================

enum ProviderType {
  COURT
  WORKSHOP
}

enum ProviderStatus {
  PENDING_APPROVAL
  APPROVED
  REJECTED
  SUSPENDED
}

model ProviderApplication {
  id            String         @id @default(cuid())
  userId        String
  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  type          ProviderType
  status        ProviderStatus @default(PENDING_APPROVAL)
  businessName  String
  businessPhone String
  businessEmail String?
  description   String?
  documentUrls  String[]       @default([])
  reviewedAt    DateTime?
  reviewNotes   String?
  reviewedBy    String?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  @@unique([userId, type])
  @@index([status, type])
  @@index([userId])
  @@map("provider_applications")
}

// ============================================
// USER & AUTH
// ============================================

model User {
  id           String           @id @default(cuid())
  email        String           @unique
  name         String?
  password     String
  image        String?
  role         UserRole         @default(USER)
  accountType  AccountType      @default(PLAYER)
  subscription SubscriptionTier @default(FREE)

  // Email verification
  emailVerified DateTime?

  // Onboarding
  onboardingCompleted Boolean @default(false)

  // Culqi fields
  culqiCustomerId       String?   @unique
  culqiSubscriptionId   String?
  culqiCurrentPeriodEnd DateTime?

  // Email notification preferences
  emailNotifications Boolean @default(true)
  reminderTime       String? // HH:mm format for daily reminders

  favoriteSports  UserSport[]
  preferredAngles String[]    @default([])

  analyses      Analysis[]
  trainingPlans TrainingPlan[]
  progressLogs  ProgressLog[]

  // Gamification
  streak       UserStreak?
  badges       UserBadge[]
  activityLogs ActivityLog[]

  // Auth tokens
  verificationTokens VerificationToken[]

  // RAG documents
  documents Document[]

  // Competition & Community
  playerProfile PlayerProfile?
  coachProfile  CoachProfile?
  notifications Notification[]

  // Shop & Stringing
  cart            Cart?
  shopOrders      ShopOrder[]
  stringingOrders StringingOrder[]
  productReviews  ProductReview[]

  // Provider
  providerApplications ProviderApplication[]
  ownedCourts          Court[]               @relation("OwnedCourts")
  ownedWorkshops       Workshop[]            @relation("OwnedWorkshops")

  // Courts
  courtBookings CourtBooking[]

  // Goals
  improvementGoals ImprovementGoal[]

  // Sport Addons (paid additional sports)
  sportAddons SportAddon[]

  bannedAt       DateTime?
  suspendedUntil DateTime?

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  lastLoginAt DateTime?

  @@map("users")
}

model UserSport {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  sportId   String
  sport     Sport    @relation(fields: [sportId], references: [id])
  level     String?
  yearsExp  Int?
  createdAt DateTime @default(now())

  @@unique([userId, sportId])
  @@map("user_sports")
}

// ============================================
// SPORTS CATALOG
// ============================================

model Sport {
  id          String  @id @default(cuid())
  slug        String  @unique
  name        String  @unique
  description String?
  icon        String?
  isActive    Boolean @default(true)
  order       Int     @default(0)

  techniques    Technique[]
  users         UserSport[]
  sportProfiles SportProfile[]
  rankings      Ranking[]
  addons        SportAddon[]
  courts        Court[]
  tournaments   Tournament[]
  matches       Match[]
  challenges    Challenge[]
  feedItems     FeedItem[]

  configSchema Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("sports")
}

model Technique {
  id          String  @id @default(cuid())
  sportId     String
  sport       Sport   @relation(fields: [sportId], references: [id], onDelete: Cascade)
  slug        String
  name        String
  description String?
  difficulty  Int     @default(1)

  correctForm  Json?
  commonErrors Json?
  keyPoints    String[]
  weight       Float    @default(0.6)

  variants        Variant[]
  analyses        Analysis[]
  techniqueScores TechniqueScore[]
  goals           GoalTechnique[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([sportId, slug])
  @@index([sportId])
  @@map("techniques")
}

model Variant {
  id          String    @id @default(cuid())
  techniqueId String
  technique   Technique @relation(fields: [techniqueId], references: [id], onDelete: Cascade)
  slug        String
  name        String
  description String?

  correctForm    Json?
  keyDifferences String[]

  analyses Analysis[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([techniqueId, slug])
  @@index([techniqueId])
  @@map("variants")
}

// ============================================
// ANALYSIS
// ============================================

model Analysis {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  techniqueId String
  technique   Technique @relation(fields: [techniqueId], references: [id])
  variantId   String?
  variant     Variant?  @relation(fields: [variantId], references: [id])

  mediaItems MediaItem[]

  status              AnalysisStatus @default(PENDING)
  errorMessage        String?
  processingMs        Int?
  processingStartedAt DateTime?
  retryCount          Int            @default(0)

  overallScore  Float?
  aiResponse    Json?
  summary       String?
  strengths     String[] @default([])
  priorityFocus String?
  modelUsed     String?

  issues Issue[]

  trainingPlan TrainingPlan?
  verification AnalysisVerification?

  previousAnalysisId String?   @unique
  previousAnalysis   Analysis? @relation("ProgressComparison", fields: [previousAnalysisId], references: [id])
  nextAnalysis       Analysis? @relation("ProgressComparison")

  goals GoalAnalysis[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, createdAt])
  @@index([techniqueId])
  @@map("analyses")
}

model MediaItem {
  id         String   @id @default(cuid())
  analysisId String
  analysis   Analysis @relation(fields: [analysisId], references: [id], onDelete: Cascade)

  type         MediaType
  url          String
  thumbnailUrl String?
  filename     String
  fileSize     Int
  duration     Int?
  angle        String?

  frameUrls String[] @default([])

  createdAt DateTime @default(now())

  @@index([analysisId])
  @@map("media_items")
}

model Issue {
  id         String   @id @default(cuid())
  analysisId String
  analysis   Analysis @relation(fields: [analysisId], references: [id], onDelete: Cascade)

  category    String
  title       String
  description String
  severity    Severity

  correction String
  drills     String[]

  timestamp Float?
  frameUrl  String?

  exercises ExerciseIssue[]

  createdAt DateTime @default(now())

  @@index([analysisId])
  @@map("issues")
}

// ============================================
// TRAINING PLANS
// ============================================

model TrainingPlan {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  analysisId String   @unique
  analysis   Analysis @relation(fields: [analysisId], references: [id])

  title        String
  description  String?
  durationDays Int
  difficulty   Int     @default(1)

  status PlanStatus @default(ACTIVE)

  exercises    Exercise[]
  progressLogs ProgressLog[]

  // Coach assignment
  coachAssignment   CoachAssignedPlan?
  assignedByCoachId String?

  // Goals
  goals GoalTrainingPlan[]

  startedAt   DateTime?
  completedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, status])
  @@index([analysisId])
  @@map("training_plans")
}

model Exercise {
  id             String       @id @default(cuid())
  trainingPlanId String
  trainingPlan   TrainingPlan @relation(fields: [trainingPlanId], references: [id], onDelete: Cascade)

  name         String
  description  String
  instructions String

  dayNumber  Int
  orderInDay Int

  sets         Int?
  reps         Int?
  durationMins Int?
  restSeconds  Int?

  videoUrl  String?
  imageUrls String[] @default([])

  frequency String

  targetIssues ExerciseIssue[]
  progressLogs ProgressLog[]

  createdAt DateTime @default(now())

  @@index([trainingPlanId, dayNumber])
  @@map("exercises")
}

model ExerciseIssue {
  id         String   @id @default(cuid())
  exerciseId String
  exercise   Exercise @relation(fields: [exerciseId], references: [id], onDelete: Cascade)
  issueId    String
  issue      Issue    @relation(fields: [issueId], references: [id], onDelete: Cascade)

  @@unique([exerciseId, issueId])
  @@map("exercise_issues")
}

model ProgressLog {
  id             String       @id @default(cuid())
  userId         String
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  trainingPlanId String
  trainingPlan   TrainingPlan @relation(fields: [trainingPlanId], references: [id], onDelete: Cascade)
  exerciseId     String?
  exercise       Exercise?    @relation(fields: [exerciseId], references: [id])

  date          DateTime @db.Date
  completed     Boolean  @default(false)
  setsCompleted Int?
  repsCompleted Int?
  durationMins  Int?

  difficulty Int?
  notes      String?

  createdAt DateTime @default(now())

  @@unique([trainingPlanId, exerciseId, date])
  @@index([userId, date])
  @@map("progress_logs")
}

// ============================================
// EXERCISE LIBRARY
// ============================================

model ExerciseTemplate {
  id           String @id @default(cuid())
  slug         String @unique
  name         String
  description  String
  instructions String

  category    String
  targetAreas String[]
  sportSlugs  String[]

  defaultSets         Int?
  defaultReps         Int?
  defaultDurationMins Int?

  videoUrl  String?
  imageUrls String[] @default([])

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("exercise_templates")
}

// ============================================
// AUTH & VERIFICATION
// ============================================

model VerificationToken {
  id        String    @id @default(cuid())
  token     String    @unique
  type      TokenType
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  usedAt    DateTime?

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([token])
  @@map("verification_tokens")
}

// ============================================
// GAMIFICATION
// ============================================

model UserStreak {
  id               String    @id @default(cuid())
  userId           String    @unique
  user             User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  currentStreak    Int       @default(0)
  longestStreak    Int       @default(0)
  lastActivityAt   DateTime?
  freezesAvailable Int       @default(1)
  freezeUsedAt     DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("user_streaks")
}

model UserBadge {
  id        String    @id @default(cuid())
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  badgeType BadgeType
  earnedAt  DateTime  @default(now())

  @@unique([userId, badgeType])
  @@index([userId])
  @@map("user_badges")
}

model ActivityLog {
  id            String   @id @default(cuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  date          DateTime @db.Date
  analysisCount Int      @default(0)
  exerciseCount Int      @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, date])
  @@index([userId, date])
  @@map("activity_logs")
}

// ============================================
// RAG - KNOWLEDGE BASE
// ============================================

model Document {
  id           String          @id @default(cuid())
  filename     String
  originalName String
  fileUrl      String
  fileSize     Int
  pageCount    Int?
  sportSlug    String?
  language     String          @default("es")
  status       DocumentStatus  @default(UPLOADING)
  errorMessage String?
  uploadedById String
  uploadedBy   User            @relation(fields: [uploadedById], references: [id], onDelete: Cascade)
  chunks       DocumentChunk[]
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt

  @@map("documents")
}

model DocumentChunk {
  id         String        @id @default(cuid())
  documentId String
  document   Document      @relation(fields: [documentId], references: [id], onDelete: Cascade)
  content    String
  chunkIndex Int
  pageStart  Int?
  pageEnd    Int?
  sportSlug  String?
  category   ChunkCategory @default(GENERAL)
  technique  String?
  tokenCount Int?
  createdAt  DateTime      @default(now())

  // Note: embedding vector(768) column added via raw SQL migration (Gemini text-embedding-004)

  @@index([documentId])
  @@index([sportSlug])
  @@index([category])
  @@index([technique])
  @@map("document_chunks")
}

// ============================================
// PLAYER PROFILES & SKILL SCORES
// ============================================

model PlayerProfile {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Display
  displayName String?
  bio         String?
  avatarUrl   String?

  // Location (Peru first)
  country   String  @default("PE")
  region    String?
  city      String?
  latitude  Float?
  longitude Float?

  // Tennis profile
  playStyle    String?
  dominantHand String?
  backhandType String?
  yearsPlaying Int?
  ageGroup     String?

  // Composite score
  compositeScore Float?
  skillTier      SkillTier @default(UNRANKED)
  effectiveScore Float?

  // Privacy
  visibility   ProfileVisibility @default(PUBLIC)
  showRealName Boolean           @default(true)
  showLocation Boolean           @default(true)

  // Denormalized stats
  totalAnalyses   Int  @default(0)
  totalTechniques Int  @default(0)
  globalRank      Int?
  countryRank     Int?

  // Matchmaking
  matchElo            Int    @default(1200)
  matchesPlayed       Int    @default(0)
  matchesWon          Int    @default(0)
  maxTravelKm         Int    @default(25)
  sportsmanshipRating Float?
  totalRatings        Int    @default(0)

  // Social
  followersCount Int @default(0)
  followingCount Int @default(0)

  lastScoreUpdate DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  sportProfiles        SportProfile[]
  techniqueScores      TechniqueScore[]
  rankings             Ranking[]
  availabilities       PlayerAvailability[]
  challengesSent       Challenge[]             @relation("ChallengesSent")
  challengesReceived   Challenge[]             @relation("ChallengesReceived")
  matchesAsP1          Match[]                 @relation("MatchP1")
  matchesAsP2          Match[]                 @relation("MatchP2")
  following            Follow[]                @relation("Following")
  followers            Follow[]                @relation("Followers")
  feedItems            FeedItem[]
  comments             Comment[]
  ownedClubs           Club[]                  @relation("ClubOwner")
  clubMemberships      ClubMember[]
  coachStudents        CoachStudent[]
  organizedTournaments Tournament[]            @relation("TournamentOrganizer")
  tournamentEntries    TournamentParticipant[]
  blocksSent           Block[]                 @relation("BlocksSent")
  blocksReceived       Block[]                 @relation("BlocksReceived")
  reportsSent          Report[]                @relation("ReportsSent")
  reportsReceived      Report[]                @relation("ReportsReceived")
  coachReviewsGiven    CoachReview[]           @relation("CoachReviewsGiven")
  ratingsGiven         MatchRating[]           @relation("RatingsGiven")
  ratingsReceived      MatchRating[]           @relation("RatingsReceived")

  @@index([country, compositeScore])
  @@index([country, effectiveScore])
  @@index([skillTier])
  @@map("player_profiles")
}

model TechniqueScore {
  id          String        @id @default(cuid())
  profileId   String
  profile     PlayerProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  techniqueId String
  technique   Technique     @relation(fields: [techniqueId], references: [id])

  sportProfileId String?
  sportProfile   SportProfile? @relation(fields: [sportProfileId], references: [id], onDelete: SetNull)

  bestScore      Float
  averageScore   Float
  analysisCount  Int       @default(0)
  lastAnalysisId String?
  lastAnalyzedAt DateTime?
  scoreHistory   Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([profileId, techniqueId])
  @@map("technique_scores")
}

// ============================================
// RANKINGS & LEADERBOARDS
// ============================================

model Ranking {
  id        String        @id @default(cuid())
  profileId String
  profile   PlayerProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  sportId String?
  sport   Sport?  @relation(fields: [sportId], references: [id])

  category  RankingCategory
  period    RankingPeriod
  country   String?
  skillTier SkillTier?
  ageGroup  String?

  rank           Int
  previousRank   Int?
  effectiveScore Float

  periodStart DateTime
  periodEnd   DateTime?

  computedAt DateTime @default(now())

  @@unique([profileId, category, period, country, skillTier, ageGroup, periodStart])
  @@index([category, period, country, rank])
  @@index([profileId])
  @@index([sportId])
  @@map("rankings")
}

// ============================================
// MATCHMAKING & CHALLENGES
// ============================================

model PlayerAvailability {
  id        String          @id @default(cuid())
  profileId String
  profile   PlayerProfile   @relation(fields: [profileId], references: [id], onDelete: Cascade)
  day       AvailabilityDay
  startTime String
  endTime   String

  @@unique([profileId, day, startTime])
  @@map("player_availabilities")
}

model Challenge {
  id           String        @id @default(cuid())
  challengerId String
  challenger   PlayerProfile @relation("ChallengesSent", fields: [challengerId], references: [id], onDelete: Cascade)
  challengedId String
  challenged   PlayerProfile @relation("ChallengesReceived", fields: [challengedId], references: [id], onDelete: Cascade)

  status          ChallengeStatus @default(PENDING)
  proposedDate    DateTime?
  proposedTime    String?
  proposedVenue   String?
  message         String?
  responseMessage String?
  respondedAt     DateTime?
  match           Match?
  expiresAt       DateTime

  sportId String?
  sport   Sport?  @relation(fields: [sportId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([challengerId, status])
  @@index([challengedId, status])
  @@index([expiresAt, status])
  @@index([sportId])
  @@map("challenges")
}

model Match {
  id          String     @id @default(cuid())
  challengeId String?    @unique
  challenge   Challenge? @relation(fields: [challengeId], references: [id])

  player1Id String
  player1   PlayerProfile @relation("MatchP1", fields: [player1Id], references: [id])
  player2Id String
  player2   PlayerProfile @relation("MatchP2", fields: [player2Id], references: [id])

  player1Result MatchResultType?
  player2Result MatchResultType?
  score         String?
  sets          Json?

  player1Confirmed Boolean @default(false)
  player2Confirmed Boolean @default(false)
  player1EloChange Int?
  player2EloChange Int?

  venue    String?
  playedAt DateTime?

  sportId String?
  sport   Sport?  @relation(fields: [sportId], references: [id], onDelete: SetNull)

  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  ratings           MatchRating[]
  tournamentBracket TournamentBracket?

  @@index([player1Id])
  @@index([player2Id])
  @@index([playedAt])
  @@index([sportId])
  @@map("matches")
}

model MatchRating {
  id            String        @id @default(cuid())
  matchId       String
  match         Match         @relation(fields: [matchId], references: [id], onDelete: Cascade)
  raterId       String
  rater         PlayerProfile @relation("RatingsGiven", fields: [raterId], references: [id], onDelete: Cascade)
  ratedId       String
  rated         PlayerProfile @relation("RatingsReceived", fields: [ratedId], references: [id], onDelete: Cascade)
  sportsmanship Int
  punctuality   Int
  skillAccuracy Int
  comment       String?

  createdAt DateTime @default(now())

  @@unique([matchId, raterId])
  @@map("match_ratings")
}

// ============================================
// COMMUNITY & SOCIAL
// ============================================

model Follow {
  id          String        @id @default(cuid())
  followerId  String
  follower    PlayerProfile @relation("Following", fields: [followerId], references: [id], onDelete: Cascade)
  followingId String
  following   PlayerProfile @relation("Followers", fields: [followingId], references: [id], onDelete: Cascade)
  createdAt   DateTime      @default(now())

  @@unique([followerId, followingId])
  @@index([followerId])
  @@index([followingId])
  @@map("follows")
}

model FeedItem {
  id            String        @id @default(cuid())
  profileId     String
  profile       PlayerProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  type          FeedItemType
  title         String
  description   String?
  referenceId   String?
  referenceType String?
  metadata      Json?
  sportId       String?
  sport         Sport?        @relation(fields: [sportId], references: [id])
  createdAt     DateTime      @default(now())

  @@index([profileId, createdAt])
  @@index([createdAt])
  @@index([sportId])
  @@map("feed_items")
}

model Comment {
  id          String        @id @default(cuid())
  authorId    String
  author      PlayerProfile @relation(fields: [authorId], references: [id], onDelete: Cascade)
  targetId    String
  targetType  String
  content     String
  isHidden    Boolean       @default(false)
  reportCount Int           @default(0)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@index([targetId, targetType, createdAt])
  @@index([authorId])
  @@map("comments")
}

model Notification {
  id            String           @id @default(cuid())
  userId        String
  user          User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  type          NotificationType
  title         String
  body          String?
  referenceId   String?
  referenceType String?
  read          Boolean          @default(false)
  readAt        DateTime?
  createdAt     DateTime         @default(now())

  @@index([userId, read, createdAt])
  @@map("notifications")
}

model Block {
  id        String        @id @default(cuid())
  blockerId String
  blocker   PlayerProfile @relation("BlocksSent", fields: [blockerId], references: [id], onDelete: Cascade)
  blockedId String
  blocked   PlayerProfile @relation("BlocksReceived", fields: [blockedId], references: [id], onDelete: Cascade)
  createdAt DateTime      @default(now())

  @@unique([blockerId, blockedId])
  @@index([blockerId])
  @@index([blockedId])
  @@map("blocks")
}

model Report {
  id             String        @id @default(cuid())
  reporterId     String
  reporter       PlayerProfile @relation("ReportsSent", fields: [reporterId], references: [id], onDelete: Cascade)
  targetId       String
  target         PlayerProfile @relation("ReportsReceived", fields: [targetId], references: [id], onDelete: Cascade)
  targetType     String
  reason         ReportReason
  description    String?
  resolved       Boolean       @default(false)
  resolvedAction String?
  resolvedAt     DateTime?
  resolvedById   String?
  createdAt      DateTime      @default(now())

  @@index([resolved])
  @@map("reports")
}

model Club {
  id          String         @id @default(cuid())
  name        String
  slug        String         @unique
  description String?
  imageUrl    String?
  country     String?
  city        String?
  ownerId     String?
  owner       PlayerProfile? @relation("ClubOwner", fields: [ownerId], references: [id], onDelete: SetNull)
  members     ClubMember[]
  tournaments Tournament[]
  isPublic    Boolean        @default(true)
  maxMembers  Int            @default(50)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  @@map("clubs")
}

model ClubMember {
  id        String        @id @default(cuid())
  clubId    String
  club      Club          @relation(fields: [clubId], references: [id], onDelete: Cascade)
  profileId String
  profile   PlayerProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  role      String        @default("member")
  joinedAt  DateTime      @default(now())

  @@unique([clubId, profileId])
  @@map("club_members")
}

// ============================================
// TOURNAMENTS
// ============================================

model Tournament {
  id          String  @id @default(cuid())
  name        String
  slug        String  @unique
  description String?
  imageUrl    String?

  organizerId String
  organizer   PlayerProfile @relation("TournamentOrganizer", fields: [organizerId], references: [id])
  clubId      String?
  club        Club?         @relation(fields: [clubId], references: [id])

  format     TournamentFormat @default(SINGLE_ELIMINATION)
  maxPlayers Int              @default(16)
  status     TournamentStatus @default(REGISTRATION)

  minTier  SkillTier?
  maxTier  SkillTier?
  ageGroup String?
  country  String?

  registrationEnd DateTime
  startDate       DateTime
  endDate         DateTime?

  venue String?
  city  String?

  sportId String?
  sport   Sport?  @relation(fields: [sportId], references: [id], onDelete: SetNull)

  participants TournamentParticipant[]
  brackets     TournamentBracket[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status, country])
  @@index([clubId])
  @@index([organizerId])
  @@index([sportId])
  @@map("tournaments")
}

model TournamentParticipant {
  id           String        @id @default(cuid())
  tournamentId String
  tournament   Tournament    @relation(fields: [tournamentId], references: [id], onDelete: Cascade)
  profileId    String
  profile      PlayerProfile @relation(fields: [profileId], references: [id])

  seed          Int?
  eliminated    Boolean @default(false)
  finalPosition Int?

  registeredAt DateTime @default(now())

  @@unique([tournamentId, profileId])
  @@index([tournamentId])
  @@index([profileId])
  @@map("tournament_participants")
}

model TournamentBracket {
  id           String     @id @default(cuid())
  tournamentId String
  tournament   Tournament @relation(fields: [tournamentId], references: [id], onDelete: Cascade)

  round    Int
  position Int
  matchId  String? @unique
  match    Match?  @relation(fields: [matchId], references: [id])

  player1Id String?
  player2Id String?
  winnerId  String?

  scheduledAt DateTime?

  @@unique([tournamentId, round, position])
  @@map("tournament_brackets")
}

// ============================================
// COACH PROFILES
// ============================================

model CoachProfile {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  headline        String?
  bio             String?
  certifications  String[] @default([])
  yearsExperience Int?
  specialties     String[] @default([])

  verificationStatus CoachVerificationStatus @default(PENDING_VERIFICATION)
  verificationDocUrl String?
  verifiedAt         DateTime?

  country String?
  city    String?

  hourlyRate  Float?
  currency    String  @default("PEN")
  isAvailable Boolean @default(true)

  averageRating Float?
  totalReviews  Int    @default(0)

  students      CoachStudent[]
  reviews       CoachReview[]
  assignedPlans CoachAssignedPlan[]

  culqiConnectId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([country, isAvailable])
  @@map("coach_profiles")
}

model CoachStudent {
  id        String        @id @default(cuid())
  coachId   String
  coach     CoachProfile  @relation(fields: [coachId], references: [id], onDelete: Cascade)
  studentId String
  student   PlayerProfile @relation(fields: [studentId], references: [id], onDelete: Cascade)

  status          CoachStudentStatus @default(PENDING_INVITE)
  canViewAnalyses Boolean            @default(true)
  canAssignPlans  Boolean            @default(true)

  startedAt DateTime?
  endedAt   DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@unique([coachId, studentId])
  @@index([coachId])
  @@index([studentId])
  @@map("coach_students")
}

model CoachAssignedPlan {
  id             String       @id @default(cuid())
  coachId        String
  coach          CoachProfile @relation(fields: [coachId], references: [id])
  studentId      String
  trainingPlanId String       @unique
  trainingPlan   TrainingPlan @relation(fields: [trainingPlanId], references: [id])
  notes          String?
  assignedAt     DateTime     @default(now())

  @@map("coach_assigned_plans")
}

model CoachReview {
  id         String        @id @default(cuid())
  coachId    String
  coach      CoachProfile  @relation(fields: [coachId], references: [id], onDelete: Cascade)
  reviewerId String
  reviewer   PlayerProfile @relation("CoachReviewsGiven", fields: [reviewerId], references: [id], onDelete: Cascade)
  rating     Int
  comment    String?
  createdAt  DateTime      @default(now())

  @@unique([coachId, reviewerId])
  @@map("coach_reviews")
}

// ============================================
// VIDEO VERIFICATION
// ============================================

model AnalysisVerification {
  id         String   @id @default(cuid())
  analysisId String   @unique
  analysis   Analysis @relation(fields: [analysisId], references: [id], onDelete: Cascade)

  status            VerificationStatus @default(UNVERIFIED)
  verificationScore Float?

  hasMetadata Boolean   @default(false)
  recordedAt  DateTime?
  deviceInfo  String?

  videoFingerprint String?
  isDuplicate      Boolean @default(false)

  peerReviewCount Int @default(0)
  peerApprovals   Int @default(0)
  peerRejections  Int @default(0)

  reviewedAt  DateTime?
  reviewNotes String?

  peerReviews PeerReview[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("analysis_verifications")
}

model PeerReview {
  id             String               @id @default(cuid())
  verificationId String
  verification   AnalysisVerification @relation(fields: [verificationId], references: [id], onDelete: Cascade)
  reviewerId     String
  approved       Boolean
  comment        String?
  createdAt      DateTime             @default(now())

  @@unique([verificationId, reviewerId])
  @@map("peer_reviews")
}

// ============================================
// SHOP - PRODUCTS
// ============================================

model Product {
  id          String  @id @default(cuid())
  slug        String  @unique
  name        String
  description String
  shortDesc   String?

  category ProductCategory
  brand    String
  model    String?

  // Pricing in centimos (PEN cents)
  priceCents        Int
  comparePriceCents Int? // "antes" price for discount display
  costCents         Int? // internal cost

  // Inventory
  stock             Int     @default(0)
  sku               String? @unique
  lowStockThreshold Int     @default(5)

  // Media
  images       String[] @default([])
  thumbnailUrl String?

  // Tennis-specific attributes (JSON for flexibility)
  attributes Json? // weight, headSize, stringPattern, gripSize, etc.

  // Marketplace future: nullable vendorId
  vendorId String?

  // Status
  isActive   Boolean @default(true)
  isFeatured Boolean @default(false)

  // SEO
  metaTitle       String?
  metaDescription String?

  cartItems  CartItem[]
  orderItems ShopOrderItem[]
  reviews    ProductReview[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([category, isActive])
  @@index([brand])
  @@index([isFeatured])
  @@map("products")
}

model ProductReview {
  id        String  @id @default(cuid())
  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  userId    String
  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  rating             Int // 1-5
  title              String?
  comment            String?
  isVerifiedPurchase Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([productId, userId])
  @@index([productId, createdAt])
  @@map("product_reviews")
}

// ============================================
// SHOP - CART
// ============================================

model Cart {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  items CartItem[]

  updatedAt DateTime @updatedAt
  createdAt DateTime @default(now())

  @@map("carts")
}

model CartItem {
  id        String  @id @default(cuid())
  cartId    String
  cart      Cart    @relation(fields: [cartId], references: [id], onDelete: Cascade)
  productId String
  product   Product @relation(fields: [productId], references: [id])
  quantity  Int     @default(1)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([cartId, productId])
  @@map("cart_items")
}

// ============================================
// SHOP - ORDERS
// ============================================

model ShopOrder {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  orderNumber String @unique // e.g., "ORD-20260127-XXXX"

  status OrderStatus @default(PENDING_PAYMENT)

  // Amounts in centimos
  subtotalCents Int
  shippingCents Int @default(0)
  discountCents Int @default(0)
  totalCents    Int

  // Shipping address
  shippingName     String
  shippingPhone    String
  shippingAddress  String
  shippingDistrict String
  shippingCity     String  @default("Lima")
  shippingNotes    String?

  // Culqi
  culqiChargeId String?

  // Marketplace future
  vendorId String?

  items ShopOrderItem[]

  paidAt      DateTime?
  shippedAt   DateTime?
  deliveredAt DateTime?
  cancelledAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, createdAt])
  @@index([status, createdAt])
  @@index([orderNumber])
  @@map("shop_orders")
}

model ShopOrderItem {
  id        String    @id @default(cuid())
  orderId   String
  order     ShopOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productId String
  product   Product   @relation(fields: [productId], references: [id])

  quantity    Int
  priceCents  Int // snapshot at time of purchase
  productName String // snapshot
  productSlug String // snapshot

  createdAt DateTime @default(now())

  @@index([orderId])
  @@map("shop_order_items")
}

// ============================================
// STRINGING SERVICE
// ============================================

model Workshop {
  id        String  @id @default(cuid())
  name      String
  address   String
  district  String
  city      String  @default("Lima")
  phone     String?
  latitude  Float?
  longitude Float?
  isActive  Boolean @default(true)
  isPartner Boolean @default(false) // own vs partner workshop

  operatingHours Json? // { mon: "9:00-18:00", ... }

  // Provider ownership
  ownerId String?
  owner   User?   @relation("OwnedWorkshops", fields: [ownerId], references: [id], onDelete: SetNull)

  stringingOrders StringingOrder[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([ownerId])
  @@index([city, district, isActive])
  @@map("workshops")
}

model StringingOrder {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  orderNumber String @unique // e.g., "STR-20260127-XXXX"

  status       StringingOrderStatus @default(PENDING_PAYMENT)
  serviceType  StringingServiceType @default(STANDARD)
  deliveryMode DeliveryMode

  // Racket info
  racketBrand String
  racketModel String
  racketNotes String?

  // String selection
  stringName      String // e.g., "Yonex Poly Tour Pro 125"
  stringProductId String? // optional link to shop Product
  tensionMain     Int // in lbs
  tensionCross    Int? // if different from main, in lbs

  // Workshop
  workshopId String?
  workshop   Workshop? @relation(fields: [workshopId], references: [id])

  // Pricing in centimos
  servicePriceCents Int
  stringPriceCents  Int @default(0) // if string included
  pickupFeeCents    Int @default(0)
  totalCents        Int

  // Address (for home pickup/delivery)
  pickupAddress    String?
  pickupDistrict   String?
  deliveryAddress  String?
  deliveryDistrict String?
  contactPhone     String

  // Scheduling
  preferredPickupDate     DateTime?
  scheduledPickupDate     DateTime?
  estimatedCompletionDate DateTime?

  // Culqi
  culqiChargeId String?

  // Tracking notes (admin sets these)
  internalNotes String?

  paidAt      DateTime?
  confirmedAt DateTime?
  receivedAt  DateTime?
  completedAt DateTime?
  deliveredAt DateTime?
  cancelledAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, createdAt])
  @@index([status])
  @@index([workshopId])
  @@map("stringing_orders")
}

// ==========================================
// COURTS & BOOKINGS
// ==========================================

enum CourtSurface {
  HARD
  CLAY
  GRASS
  SYNTHETIC
}

enum CourtType {
  INDOOR
  OUTDOOR
  COVERED
}

enum BookingStatus {
  PENDING
  PENDING_PAYMENT
  CONFIRMED
  REJECTED
  CANCELLED
}

model Court {
  id             String       @id @default(cuid())
  name           String
  description    String?
  address        String
  district       String
  city           String       @default("Lima")
  country        String       @default("PE")
  phone          String?
  whatsapp       String?
  website        String?
  imageUrl       String?
  latitude       Float?
  longitude      Float?
  surface        CourtSurface @default(HARD)
  courtType      CourtType    @default(OUTDOOR)
  hourlyRate     Float?
  currency       String       @default("PEN")
  amenities      String[]
  isActive       Boolean      @default(true)
  operatingHours Json?

  // Provider ownership
  ownerId String?
  owner   User?   @relation("OwnedCourts", fields: [ownerId], references: [id], onDelete: SetNull)

  sportId String?
  sport   Sport?  @relation(fields: [sportId], references: [id], onDelete: SetNull)

  bookings  CourtBooking[]
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt

  @@index([city, district, isActive])
  @@index([surface])
  @@index([ownerId])
  @@index([sportId])
  @@map("courts")
}

model CourtBooking {
  id        String        @id @default(cuid())
  courtId   String
  court     Court         @relation(fields: [courtId], references: [id], onDelete: Cascade)
  userId    String
  user      User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  date      DateTime
  startTime String
  endTime   String
  status    BookingStatus @default(PENDING)
  notes     String?

  // Confirmation flow
  confirmationNote String?
  confirmedAt      DateTime?
  rejectedAt       DateTime?

  // Payment
  estimatedTotalCents Int?
  totalCents          Int?
  culqiChargeId       String?
  refundCulqiId       String?
  paidAt              DateTime?

  // Booking expiration (unpaid bookings auto-expire)
  expiresAt DateTime?

  createdAt DateTime @default(now())

  @@index([courtId, date])
  @@index([userId])
  @@index([expiresAt, status])
  @@map("court_bookings")
}

// ============================================
// IMPROVEMENT GOALS
// ============================================

enum GoalType {
  TECHNIQUE
  SCORE_TARGET
  TIER_TARGET
}

enum GoalStatus {
  ACTIVE
  COMPLETED
  ABANDONED
}

model ImprovementGoal {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  type        GoalType
  title       String
  description String?

  targetScore Float?
  targetTier  SkillTier?

  baselineScore   Float?
  currentScore    Float?
  progressPercent Float? @default(0)

  roadmap Json?

  status      GoalStatus @default(ACTIVE)
  completedAt DateTime?
  abandonedAt DateTime?

  techniques    GoalTechnique[]
  trainingPlans GoalTrainingPlan[]
  analyses      GoalAnalysis[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, status])
  @@index([userId, createdAt])
  @@map("improvement_goals")
}

model GoalTechnique {
  id          String          @id @default(cuid())
  goalId      String
  goal        ImprovementGoal @relation(fields: [goalId], references: [id], onDelete: Cascade)
  techniqueId String
  technique   Technique       @relation(fields: [techniqueId], references: [id], onDelete: Cascade)

  @@unique([goalId, techniqueId])
  @@index([goalId])
  @@index([techniqueId])
  @@map("goal_techniques")
}

model GoalTrainingPlan {
  id             String          @id @default(cuid())
  goalId         String
  goal           ImprovementGoal @relation(fields: [goalId], references: [id], onDelete: Cascade)
  trainingPlanId String
  trainingPlan   TrainingPlan    @relation(fields: [trainingPlanId], references: [id], onDelete: Cascade)

  @@unique([goalId, trainingPlanId])
  @@map("goal_training_plans")
}

model GoalAnalysis {
  id         String          @id @default(cuid())
  goalId     String
  goal       ImprovementGoal @relation(fields: [goalId], references: [id], onDelete: Cascade)
  analysisId String
  analysis   Analysis        @relation(fields: [analysisId], references: [id], onDelete: Cascade)
  scoreDelta Float?

  @@unique([goalId, analysisId])
  @@map("goal_analyses")
}

// ============================================
// MULTI-SPORT PROFILES
// ============================================

model SportProfile {
  id        String        @id @default(cuid())
  profileId String
  profile   PlayerProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  sportId   String
  sport     Sport         @relation(fields: [sportId], references: [id])

  sportConfig Json?

  compositeScore  Float?
  skillTier       SkillTier @default(UNRANKED)
  effectiveScore  Float?
  totalAnalyses   Int       @default(0)
  totalTechniques Int       @default(0)
  lastScoreUpdate DateTime?

  matchElo      Int  @default(1200)
  matchesPlayed Int  @default(0)
  matchesWon    Int  @default(0)
  globalRank    Int?
  countryRank   Int?

  techniqueScores TechniqueScore[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([profileId, sportId])
  @@index([sportId, effectiveScore])
  @@index([profileId])
  @@map("sport_profiles")
}

model SportAddon {
  id      String @id @default(cuid())
  userId  String
  user    User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  sportId String
  sport   Sport  @relation(fields: [sportId], references: [id])

  active              Boolean @default(true)
  culqiSubscriptionId String?

  createdAt DateTime @default(now())

  @@unique([userId, sportId])
  @@map("sport_addons")
}

// ============================================
// CRON JOB LOCKS
// ============================================

model CronLock {
  id        String   @id
  lockedAt  DateTime @default(now())
  expiresAt DateTime

  @@map("cron_locks")
}
